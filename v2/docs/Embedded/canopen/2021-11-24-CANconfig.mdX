---
id: 2021-11-24-CANconfig
description:  ç§»æ¤ç¯‡ï¼šCANé…ç½®
# slug: åŸç†ç¯‡ï¼šCANä¸CANOpenåŸºç¡€
title: ğŸ—£ï¸ ç§»æ¤ç¯‡ï¼šCANé…ç½®
sidebar_position: 3
tags:
    - P 1.2
   #  - Work needed
---

<!-- ---
title: ç§»æ¤ç¯‡ï¼šCANé…ç½®
--- -->

:::info
ç¡¬ä»¶ï¼šSTM32F407å¼€å‘æ¿ï¼ŒCANè°ƒè¯•å™¨ï¼ŒSTâ€”LINKè°ƒè¯•å™¨
:::

## ä½¿ç”¨CUBEMXåˆ›å»ºå·¥ç¨‹  
## é€‰ç”¨å¤–éƒ¨é«˜é€Ÿæ™¶æŒ¯  
![0.0](/img/canconfig/0.0.png)  

## é…ç½®æ—¶é’Ÿæ ‘  
HCLKä¸€èˆ¬ä¸ºé»˜è®¤æœ€é«˜ï¼ŒCANä½¿ç”¨çš„æ˜¯APB1å¤–è®¾æ—¶é’Ÿã€‚é€‰æ‹©æ—¶é’Ÿæºï¼Œè¾“å…¥éœ€è¦çš„é¢‘ç‡æŒ‰å›è½¦å³å¯è‡ªåŠ¨è°ƒæ•´å…¶ä»–å‚æ•°  
![0.1](/img/canconfig/0.1.png)  

## é…ç½®CAN  
ä½¿èƒ½åéœ€è¦æ ¹æ®æ³¢ç‰¹ç‡å¯¹å‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨ç¨‹åºä¸­ä¿®æ”¹ã€‚  
ä¸Šå›¾ä¸­å¯è§APB1ä¸º42MHzï¼Œç»è¿‡ä¸‹å›¾ä¸­é¢„åˆ†é¢‘ä¹‹å 42/3 = 14MHzã€‚ 
**å¦‚æœæˆ‘ä»¬å¸Œæœ›å¾—åˆ°1MHzæ³¢ç‰¹ç‡ï¼Œé‚£åªéœ€æ»¡è¶³Jumpwidth+seg1+seg2= 14MHz / 1MHz = 14å³å¯ï¼Œ**å…¶ä»–æ³¢ç‰¹ç‡ä»¥æ­¤ç±»æ¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä»£ç å—å®ç°æ³¢ç‰¹ç‡çš„é…ç½®ã€‚  

```

#if defined (SOC_SERIES_STM32F1)/* APB1 36MHz(max) */
static const struct stm32_baud_rate_tab can_baud_rate_tab[] =
{
    {CAN1MBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 3)},
    {CAN800kBaud, (CAN_SJW_2TQ | CAN_BS1_5TQ  | CAN_BS2_3TQ | 5)},
    {CAN500kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 6)},
    {CAN250kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 12)},
    {CAN125kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 24)},
    {CAN100kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 30)},
    {CAN50kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 60)},
    {CAN20kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 150)},
    {CAN10kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ  | CAN_BS2_3TQ | 300)}
};
#elif defined (SOC_SERIES_STM32F4)/* APB1 42MHz(max) */
static const struct stm32_baud_rate_tab can_baud_rate_tab[] =
{
    {CAN1MBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 3)},
    {CAN800kBaud, (CAN_SJW_2TQ | CAN_BS1_8TQ | CAN_BS2_4TQ | 4)},
    {CAN500kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 6)},
    {CAN250kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 12)},
    {CAN125kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 24)},
    {CAN100kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 30)},
    {CAN50kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 60)},
    {CAN20kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 150)},
    {CAN10kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ | CAN_BS2_4TQ | 300)}
};
#elif defined (SOC_SERIES_STM32F7)/* APB1 54MHz(max) */
static const struct stm32_baud_rate_tab can_baud_rate_tab[] =
{
    {CAN1MBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 3)},
    {CAN800kBaud, (CAN_SJW_2TQ | CAN_BS1_9TQ  | CAN_BS2_7TQ | 4)},
    {CAN500kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 6)},
    {CAN250kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 12)},
    {CAN125kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 24)},
    {CAN100kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 30)},
    {CAN50kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 60)},
    {CAN20kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 150)},
    {CAN10kBaud, (CAN_SJW_2TQ | CAN_BS1_10TQ  | CAN_BS2_7TQ | 300)}
};
#endif
```



![0.1](/img/canconfig/0.2.png)  

## ç”Ÿæˆä»£ç å¹¶è¿è¡Œè¯•è½¦  
cubemxç”Ÿæˆçš„é»˜è®¤ä»£ç åªæœ‰åˆå§‹åŒ–cançš„ä»£ç ï¼Œå¼€å¯canä»¥åŠå‘é€æ¥æ”¶å‡½æ•°å‡éœ€è¦è‡ªå·±ç¼–å†™ï¼Œè¿™éƒ¨åˆ†å¯å‚ç…§*_hal_can.cä¸­æä¾›çš„æ¥å£ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šç›´æ¥copyï¼Œä»¥ä¸‹æ¥è‡ªæ­£ç‚¹åŸå­   

```
void CAN_Config(void)
{
  CAN_FilterTypeDef  sFilterConfig;

  /*##-2- Configure the CAN Filter ###########################################*/
  sFilterConfig.FilterBank = 0;
  sFilterConfig.FilterMode = CAN_FILTERMODE_IDMASK;
  sFilterConfig.FilterScale = CAN_FILTERSCALE_32BIT;
  sFilterConfig.FilterIdHigh = 0x0000;
  sFilterConfig.FilterIdLow = 0x0000;
  sFilterConfig.FilterMaskIdHigh = 0x0000;
  sFilterConfig.FilterMaskIdLow = 0x0000;
  sFilterConfig.FilterFIFOAssignment = CAN_RX_FIFO0;
  sFilterConfig.FilterActivation = ENABLE;
  sFilterConfig.SlaveStartFilterBank = 14;

  if (HAL_CAN_ConfigFilter(&hcan1, &sFilterConfig) != HAL_OK)
  {
    /* Filter configuration Error */
    while(1)
	  {
	  }
  }

  /*##-3- Start the CAN peripheral ###########################################*/
  if (HAL_CAN_Start(&hcan1) != HAL_OK)
  {
    /* Start Error */
    while(1)
	  {
	  }
  }

  /*##-4- Activate CAN RX notification #######################################*/
  if (HAL_CAN_ActivateNotification(&hcan1, CAN_IT_RX_FIFO0_MSG_PENDING) != HAL_OK)
  {
    /* Notification Error */
    while(1)
	  {
	  }
  }

  /*##-5- Configure Transmission process #####################################*/
  TxHeader.StdId = 0x321;
  TxHeader.ExtId = 0x01;
  TxHeader.RTR = CAN_RTR_DATA;
  TxHeader.IDE = CAN_ID_STD;
  TxHeader.DLC = 2;
  TxHeader.TransmitGlobalTime = DISABLE;
}
```



```
u8 CAN1_Send_Msg(u8* msg,u8 len)
{
    u8 i=0;
	  u32 TxMailbox=0;
  	u8 message[8];
    TxHeader.StdId=0X12;        //
    TxHeader.ExtId=0x12;        //
    TxHeader.IDE=CAN_ID_STD;    //ä½¿ç”¨æ ‡å‡†å¸§
    TxHeader.RTR=CAN_RTR_DATA;  //
    TxHeader.DLC=len;                
    for(i=0;i<len;i++)
    {
		message[i]=msg[i];
	}
    if(HAL_CAN_AddTxMessage(&hcan1, &TxHeader, message, &TxMailbox) != HAL_OK)//Â·Â¢Ã‹Ã
	{
		return 1;
	}
	while(HAL_CAN_GetTxMailboxesFreeLevel(&hcan1) != 3) {}
    return 0;
}
```

